---
title: "Resultados y Diagn칩sticos-INLA-ST"
output: html_notebook
---

```{r}
library(tidyverse)
library(sp)
library(sf)
library(gridExtra)
library(INLA)
library(latex2exp)
```

Carga de resultados:
```{r}
load('results_INLA_ST0_draft.RData')
```

Densidades posteriores de Betas fijos
```{r}
base_grafico_betas <- bind_rows(data.frame(m.ex2$marginals.fixed$intercept,type='beta0'))
#                                data.frame(m.ex2$marginals.fixed$OMEGA,type='beta1'),
#                                data.frame(m.ex2$marginals.fixed$U,type='beta2'),
#                                data.frame(m.ex2$marginals.fixed$V,type='beta3'))

ggplot(data = base_grafico_betas,mapping = aes(x = x,y = y)) + geom_line()+
  theme_bw()+facet_wrap(vars(type),nrow = 2,scales = 'free')
```

Densidades posteriores de par치metros de rango:
```{r}
outputPC1.field <- inla.spde2.result(inla=m.ex2,
                                   name="idx.PC0", spde=spde.spatial.vcm, do.transf=TRUE)
#outputPC2.field <- inla.spde2.result(inla=m.ex2,
#                                   name="idx.PC2", spde=spde.spatial.vcm, do.transf=TRUE)
#outputPC3.field <- inla.spde2.result(inla=m.ex2,
#                                   name="idx.PC3", spde=spde.spatial.vcm, do.transf=TRUE)

base_grafico_rangos <- bind_rows(data.frame(outputPC1.field$marginals.range.nominal$range.nominal.1,type='PC0'))#,
#data.frame(outputPC2.field$marginals.range.nominal$range.nominal.1,type='PC2'),
#data.frame(outputPC3.field$marginals.range.nominal$range.nominal.1,type='PC3'))

ggplot(data = base_grafico_rangos,mapping = aes(x = x,y = y)) + geom_line()+
  theme_bw()+facet_wrap(vars(type),nrow = 2,scales = 'free')
```

Densidades posteriores de par치metros de varianza por efecto aleatorio:
```{r}
base_grafico_varianzas <- bind_rows(data.frame(outputPC1.field$marginals.variance.nominal$variance.nominal.1,type='PC0'))

#data.frame(outputPC2.field$marginals.variance.nominal$variance.nominal.1,type='PC2'),
#ata.frame(outputPC3.field$marginals.variance.nominal$variance.nominal.1,type='PC3'))

ggplot(data = base_grafico_varianzas,mapping = aes(x = x,y = y)) + geom_line()+
  theme_bw()+facet_wrap(vars(type),nrow = 2,scales = 'free')
```
Densidad posterior del efecto nugget:
```{r}
base_grafico_nugget <- data.frame(inla.tmarginal(function(x) 1/x, m.ex2$marginals.hyper$`Precision for the Gaussian observations`))

ggplot(data = base_grafico_nugget,mapping = aes(x = x,y = y)) + geom_line()+
  theme_bw()
```

Gr치ficos de observaciones vs predicciones:
```{r}
index.pred <- inla.stack.index(stack = stk, tag = "est")$data
Resumen_fitted <- m.ex2$summary.fitted.values[index.pred,]

inla.qmarginal(c(0.025,0.975),m.ex2$marginals.fitted.values[[1]])

hh_extract$Yhat <- Resumen_fitted$mean
hh_extract$Ysd <- Resumen_fitted$sd
hh_extract$Ymed <- Resumen_fitted$`0.5quant`
hh_extract$That <- exp(log(hh_extract$TREFHT)+hh_extract$Yhat)
hh_extract$Tmed <- exp(log(hh_extract$TREFHT)+hh_extract$Ymed)
hh_extract$TShat <- exp(Resumen_fitted$sd)


hh_sf <- st_as_sf(hh_extract)
grafico1 <- ggplot(data = hh_sf)+geom_sf(aes(col = ts))+
  theme_bw()+
  scale_color_distiller(type = 'seq',palette = 'YlOrRd',direction = 1)

grafico2 <- ggplot(data = hh_sf)+geom_sf(aes(col = That))+
  theme_bw()+
  scale_color_distiller(type = 'seq',palette = 'YlOrRd',direction = 1)

grafico3 <- ggplot(data = hh_sf)+geom_sf(aes(col = Tmed))+
  theme_bw()+
  scale_color_distiller(type = 'seq',palette = 'YlOrRd',direction = 1)


grafico4 <- ggplot(data = hh_sf)+geom_sf(aes(col = TShat))+
  theme_bw()+
  scale_color_distiller(type = 'seq',direction = 1)

graficos_Yposterior <- grid.arrange(grafico1,grafico2,grafico3,grafico4)
```